# دليل إنشاء قواعد البيانات على Azure لمشروع معلمي الذكي

هذا الدليل يشرح كيفية إنشاء وتكوين قواعد البيانات على Azure لمشروع معلمي الذكي، بما في ذلك:
- قاعدة بيانات PostgreSQL للبيانات الرئيسية
- قاعدة بيانات MongoDB (Cosmos DB) للإحصائيات والبيانات غير المهيكلة

## المتطلبات الأساسية

1. حساب Azure مع اشتراك نشط
2. تثبيت [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)
3. تثبيت [PowerShell 7+](https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell) (اختياري، لتشغيل السكريبتات)

## خيارات النشر

يوفر هذا المشروع ثلاثة خيارات لإنشاء قواعد البيانات على Azure:

### 1. استخدام سكريبت PowerShell المباشر

سكريبت `setup-azure-databases.ps1` يقوم بإنشاء قواعد البيانات باستخدام أوامر Azure CLI مباشرة:

```powershell
# تسجيل الدخول إلى Azure
az login

# تشغيل السكريبت مع المعلمات الافتراضية
./tools/setup-azure-databases.ps1

# أو تخصيص المعلمات
./tools/setup-azure-databases.ps1 -ResourceGroup "my-custom-rg" -Location "westeurope" -PostgresServerName "my-custom-postgres" -CosmosAccountName "my-custom-cosmos"
```

### 2. استخدام ملف Bicep (موصى به)

ملف `azure-databases.bicep` يوفر نهجًا أكثر إعلانية وقابلية للتكرار:

```powershell
# تسجيل الدخول إلى Azure
az login

# تشغيل سكريبت النشر
./tools/deploy-azure-databases.ps1

# أو تخصيص المعلمات
./tools/deploy-azure-databases.ps1 -ResourceGroup "my-custom-rg" -Location "westeurope" -PostgresServerName "my-custom-postgres"
```

### 3. استخدام بوابة Azure

يمكنك أيضًا إنشاء الموارد يدويًا من بوابة Azure:

1. قم بإنشاء خادم Azure Database for PostgreSQL المرن
2. قم بإنشاء حساب Azure Cosmos DB مع واجهة MongoDB API
3. قم بتكوين قواعد جدار الحماية والاتصالات حسب الحاجة
4. قم بتحديث ملف `.env.azure` بمعلومات الاتصال

## هيكل قواعد البيانات

### PostgreSQL

- **الغرض**: تخزين البيانات الرئيسية مثل المستخدمين، والمعلمين الذكيين، وقوالب البرومبت، ومفاتيح API
- **الجداول الرئيسية**:
  - `users`: معلومات المستخدمين
  - `ai_teachers`: المعلمون الذكيون
  - `prompt_templates`: قوالب البرومبت
  - `api_keys`: مفاتيح API (مشفرة)
  - `ai_model_configs`: تكوينات نماذج الذكاء الاصطناعي

### MongoDB (Cosmos DB)

- **الغرض**: تخزين البيانات غير المهيكلة وإحصائيات الاستخدام
- **المجموعات الرئيسية**:
  - `model_usage_stats`: إحصائيات استخدام نماذج الذكاء الاصطناعي
  - `model_fallback_logs`: سجلات تبديل النماذج
  - `prompt_library_imports`: سجلات استيراد مكتبة البرومبت

## تكوين متغيرات البيئة

بعد إنشاء قواعد البيانات، سيتم إنشاء ملف `.env.azure` يحتوي على متغيرات البيئة اللازمة للاتصال بقواعد البيانات. يمكنك استخدام هذا الملف لتكوين تطبيق Container App الخاص بك.

## الترحيلات وإعداد البيانات

بعد إنشاء قواعد البيانات، تحتاج إلى تشغيل الترحيلات لإنشاء الجداول والمخططات:

```bash
# تشغيل الترحيلات
cd my-smart-teacher/backend
npm run migration:run -- --env azure
```

## الأمان والممارسات الجيدة

1. **تشفير البيانات الحساسة**: تأكد من تشفير مفاتيح API والبيانات الحساسة الأخرى قبل تخزينها
2. **تقييد الوصول**: استخدم قواعد جدار الحماية وشبكات Azure الخاصة (VNET) لتقييد الوصول إلى قواعد البيانات
3. **النسخ الاحتياطي**: قم بتكوين النسخ الاحتياطي التلقائي لقواعد البيانات
4. **المراقبة**: قم بتكوين تنبيهات لمراقبة أداء واستخدام قواعد البيانات

## استكشاف الأخطاء وإصلاحها

### مشاكل اتصال PostgreSQL

- تحقق من قواعد جدار الحماية وإعدادات الوصول العام
- تأكد من تمكين خدمات Azure للوصول إلى الخادم
- تحقق من صحة اسم المستخدم وكلمة المرور

### مشاكل اتصال Cosmos DB

- تحقق من مفاتيح الاتصال وصلاحيتها
- تأكد من تكوين واجهة MongoDB API بشكل صحيح
- تحقق من إعدادات SSL وخيارات الاتصال

## الدعم والمساعدة

إذا واجهت أي مشاكل في إعداد قواعد البيانات، يرجى الاتصال بفريق الدعم أو فتح مشكلة في مستودع المشروع.
